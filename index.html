<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chimera Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose to window for global access
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, getFirestore, collection, addDoc, query, onSnapshot };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #050505;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        h1, h2, h3, .brand-font {
            font-family: 'Orbitron', sans-serif;
        }

        /* Neon Glow Effects */
        .neon-border {
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2), inset 0 0 10px rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
        }
        
        .neon-text {
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }

        .neon-border-red {
            box-shadow: 0 0 10px rgba(255, 50, 50, 0.2), inset 0 0 10px rgba(255, 50, 50, 0.1);
            border: 1px solid rgba(255, 50, 50, 0.3);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #00bcd4;
        }

        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(0, 255, 255, 0.2); }
            50% { box-shadow: 0 0 25px rgba(0, 255, 255, 0.5); }
        }

        @keyframes fight-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 0, 0, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 40px rgba(255, 0, 0, 0.7); }
        }

        .animate-pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #00bcd4;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .scanline {
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 255, 0.1);
            position: absolute;
            z-index: 10;
            animation: scanline 6s linear infinite;
            pointer-events: none;
        }

        @keyframes scanline {
            0% { top: 0%; }
            100% { top: 100%; }
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">
    
    <div class="scanline"></div>

    <!-- Background Grid -->
    <div class="fixed inset-0 z-[-1] opacity-20" style="background-image: radial-gradient(#1a202c 1px, transparent 1px); background-size: 30px 30px;"></div>

    <!-- Header -->
    <header class="p-6 border-b border-gray-800 bg-black/80 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-dna text-cyan-400 text-2xl"></i>
                <h1 class="text-3xl font-bold tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600">CHIMERA <span class="text-white">ARENA</span></h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-xs text-gray-500 font-mono hidden md:block" id="systemStatus">
                    SYS.STATUS: <span class="text-yellow-500">STANDBY</span>
                </div>
                <button onclick="openLoginModal()" id="loginBtn" class="bg-gray-900 hover:bg-gray-800 text-cyan-400 border border-cyan-900 px-4 py-2 rounded text-xs font-bold tracking-widest transition flex items-center gap-2">
                    <i class="fa-brands fa-google"></i> ACCESS TERMINAL
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full gap-8 grid grid-cols-1 lg:grid-cols-12">
        
        <!-- LEFT COLUMN: The Lab (Creation) -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- Creation Panel -->
            <div class="bg-gray-900/80 p-6 rounded-xl neon-border relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-30 transition">
                    <i class="fa-solid fa-flask text-6xl text-cyan-500"></i>
                </div>
                
                <h2 class="text-xl font-bold mb-4 text-cyan-400 flex items-center gap-2">
                    <i class="fa-solid fa-microchip"></i> GENETIC SPLICER
                </h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">Base Subject A</label>
                        <input type="text" id="animal1" placeholder="e.g. Lion" class="w-full bg-black border border-gray-700 rounded-md p-3 text-white focus:border-cyan-500 focus:outline-none focus:ring-1 focus:ring-cyan-500 transition font-mono">
                    </div>
                    <div class="flex justify-center -my-2 relative z-10">
                        <div class="bg-gray-900 rounded-full p-2 border border-gray-700">
                            <i class="fa-solid fa-plus text-gray-500"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">Base Subject B</label>
                        <input type="text" id="animal2" placeholder="e.g. Eagle" class="w-full bg-black border border-gray-700 rounded-md p-3 text-white focus:border-cyan-500 focus:outline-none focus:ring-1 focus:ring-cyan-500 transition font-mono">
                    </div>

                    <button onclick="createHybrid()" id="createBtn" class="w-full bg-cyan-900 hover:bg-cyan-700 text-cyan-100 font-bold py-3 px-4 rounded-md transition-all duration-300 flex justify-center items-center gap-2 neon-border mt-4">
                        <i class="fa-solid fa-bolt"></i>
                        <span>INITIATE FUSION</span>
                    </button>
                    
                    <div id="creationStatus" class="hidden text-center text-xs text-cyan-400 font-mono mt-2">
                        <div class="inline-block loader align-middle mr-2"></div> PROCESSING GENETIC DATA...
                    </div>
                </div>
            </div>

            <!-- Recent Creations (Roster) -->
            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800">
                <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider flex justify-between items-center">
                    <span>Subject Roster</span>
                    <span class="text-xs bg-gray-800 px-2 py-1 rounded" id="rosterCount">0 SUBJECTS</span>
                </h3>
                
                <div id="rosterList" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                    <div class="text-center text-gray-600 py-8 text-sm italic">
                        No subjects created yet.<br>Use the splicer above.
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: The Arena -->
        <div class="lg:col-span-8 space-y-6 flex flex-col">
            
            <!-- Battle Stage -->
            <div class="bg-black border border-gray-800 rounded-xl overflow-hidden relative min-h-[500px] flex flex-col">
                <!-- Arena Header -->
                <div class="bg-gray-900/80 border-b border-gray-800 p-4 flex justify-between items-center z-10">
                    <h2 class="text-xl font-bold text-red-500 tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-skull-crossbones"></i> BATTLE SIMULATION
                    </h2>
                    <div class="flex gap-2">
                         <button onclick="resetArena()" class="text-xs bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded text-gray-300 transition">RESET</button>
                    </div>
                </div>

                <!-- Arena Content -->
                <div class="flex-grow relative p-6 flex flex-col items-center justify-center" id="arenaContainer">
                    
                    <!-- Empty State -->
                    <div id="arenaEmptyState" class="text-center opacity-40">
                        <i class="fa-solid fa-gamepad text-6xl mb-4 text-gray-600"></i>
                        <p class="text-xl font-light">Select two subjects from the roster<br>to initiate combat protocol.</p>
                    </div>

                    <!-- Fighters Selected State (Hidden by default) -->
                    <div id="fighterSelection" class="hidden w-full max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8 items-center">
                        <!-- Fighter 1 -->
                        <div class="text-center relative group">
                            <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
                            <div class="relative bg-gray-900 rounded-lg p-2 border border-gray-700 h-64 flex flex-col">
                                <img id="fighter1Img" src="" class="w-full h-48 object-cover rounded bg-black mb-2" alt="Fighter 1">
                                <h3 id="fighter1Name" class="font-bold text-cyan-400 text-lg">???</h3>
                                <p class="text-xs text-gray-400" id="fighter1Components">Waiting for selection...</p>
                            </div>
                            <div class="absolute top-0 left-0 bg-blue-600 text-xs font-bold px-2 py-1 rounded-tl-lg rounded-br-lg z-10">P1</div>
                        </div>

                        <!-- VS Badge -->
                        <div class="flex flex-col items-center justify-center z-20">
                            <div class="text-5xl font-black italic text-transparent bg-clip-text bg-gradient-to-br from-red-500 to-orange-600 mb-4" style="text-shadow: 0 0 20px rgba(255,0,0,0.5);">VS</div>
                            <button onclick="startFight()" id="fightBtn" disabled class="disabled:opacity-50 disabled:cursor-not-allowed bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-8 rounded-full shadow-[0_0_20px_rgba(220,38,38,0.5)] transition transform hover:scale-105 flex items-center gap-2">
                                <span>FIGHT!</span>
                            </button>
                            <div id="fightStatus" class="hidden text-xs text-red-400 font-mono mt-3">
                                <div class="inline-block loader border-t-red-500 w-4 h-4 align-middle mr-1"></div> SIMULATING...
                            </div>
                        </div>

                        <!-- Fighter 2 -->
                        <div class="text-center relative group">
                            <div class="absolute -inset-1 bg-gradient-to-r from-red-600 to-orange-600 rounded-lg blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
                            <div class="relative bg-gray-900 rounded-lg p-2 border border-gray-700 h-64 flex flex-col">
                                <img id="fighter2Img" src="" class="w-full h-48 object-cover rounded bg-black mb-2" alt="Fighter 2">
                                <h3 id="fighter2Name" class="font-bold text-red-400 text-lg">???</h3>
                                <p class="text-xs text-gray-400" id="fighter2Components">Waiting for selection...</p>
                            </div>
                             <div class="absolute top-0 right-0 bg-red-600 text-xs font-bold px-2 py-1 rounded-tr-lg rounded-bl-lg z-10">P2</div>
                        </div>
                    </div>

                    <!-- Battle Result (Hidden by default) -->
                    <div id="battleResult" class="hidden w-full h-full absolute inset-0 bg-black z-30 flex flex-col">
                        <img id="battleResultImg" src="" class="w-full h-full object-contain" alt="Battle Result">
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/80 to-transparent p-8">
                            <h2 class="text-3xl font-bold text-white mb-2 brand-font">SIMULATION COMPLETE</h2>
                            <p id="battleDescription" class="text-gray-300 text-sm max-w-2xl">The dust settles...</p>
                            <button onclick="closeBattleResult()" class="mt-4 bg-white/10 hover:bg-white/20 backdrop-blur border border-white/20 text-white px-6 py-2 rounded-full text-sm transition">
                                <i class="fa-solid fa-arrow-left"></i> BACK TO ARENA
                            </button>
                        </div>
                    </div>

                </div>
            </div>
            
            <!-- Instructions / Logs -->
            <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-800 text-xs font-mono text-gray-500 h-32 overflow-y-auto" id="consoleLog">
                <div class="text-cyan-600">> SYSTEM INITIALIZED</div>
            </div>

        </div>
    </main>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="fixed inset-0 z-[100] hidden modal-backdrop flex items-center justify-center p-4">
        <div class="bg-black border border-cyan-500 rounded-lg max-w-md w-full p-6 relative shadow-[0_0_50px_rgba(0,255,255,0.2)]">
            <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white">
                <i class="fa-solid fa-times"></i>
            </button>
            
            <div class="text-center mb-6">
                <i class="fa-solid fa-shield-halved text-4xl text-cyan-500 mb-3"></i>
                <h2 class="text-2xl font-bold text-white brand-font">IDENTITY UPLINK</h2>
                <p class="text-xs text-cyan-600 font-mono mt-1">SECURE CONNECTION REQUIRED</p>
            </div>

            <div class="space-y-4">
                <div class="bg-gray-900/50 p-3 rounded border border-gray-800 text-xs text-gray-400 mb-4">
                    <i class="fa-solid fa-circle-info mr-2"></i>
                    To bypass the "API Key Missing" error, please enter a valid Google Gemini API Key below.
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider">Gemini API Key</label>
                    <input type="password" id="userApiKeyInput" placeholder="AIzaSy..." class="w-full bg-black border border-gray-700 rounded p-3 text-white focus:border-cyan-500 focus:outline-none focus:ring-1 focus:ring-cyan-500 transition font-mono">
                </div>

                <button onclick="saveApiKey()" class="w-full bg-cyan-900 hover:bg-cyan-700 text-white font-bold py-3 rounded transition neon-border mt-2">
                    <i class="fa-solid fa-link mr-2"></i> ESTABLISH CONNECTION
                </button>
                
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-800"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-600 text-xs">OR</span>
                    <div class="flex-grow border-t border-gray-800"></div>
                </div>

                <button onclick="loginAnonymously()" class="w-full bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold py-2 rounded text-xs transition">
                    CONTINUE AS GUEST (USE PUBLIC API)
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARS ---
        let apiKey = ""; // Will be populated by environment or user
        let user = null;
        let roster = [];
        let fighter1 = null;
        let fighter2 = null;

        // --- FIREBASE INIT ---
        let auth, db;
        
        async function initFirebase() {
            try {
                if (typeof __firebase_config === 'undefined') {
                    console.warn("Firebase config not found in environment.");
                    return;
                }
                const firebaseConfig = JSON.parse(__firebase_config);
                const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore } = window.firebaseModules;
                
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Auth Listener
                onAuthStateChanged(auth, (currentUser) => {
                    user = currentUser;
                    if (user) {
                        document.getElementById('loginBtn').innerHTML = `<i class="fa-solid fa-user-check text-green-400"></i> ${user.uid.substring(0,6)}...`;
                        document.getElementById('systemStatus').innerHTML = `SYS.STATUS: <span class="text-green-500">CONNECTED</span>`;
                        log(`User authenticated: ${user.uid.substring(0,8)}...`, 'success');
                    } else {
                         document.getElementById('systemStatus').innerHTML = `SYS.STATUS: <span class="text-yellow-500">STANDBY</span>`;
                    }
                });

                // Try silent login if we have a token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    // Custom token logic if needed
                } else {
                    // Optional: Auto sign-in anonymously? Let's wait for user action
                    // await signInAnonymously(auth); 
                }

            } catch (e) {
                console.error("Firebase Init Error:", e);
                log("Firebase connection failed. Local mode only.", "error");
            }
        }

        // --- DOM ELEMENTS ---
        const animal1Input = document.getElementById('animal1');
        const animal2Input = document.getElementById('animal2');
        const createBtn = document.getElementById('createBtn');
        const creationStatus = document.getElementById('creationStatus');
        const rosterList = document.getElementById('rosterList');
        const rosterCount = document.getElementById('rosterCount');
        const consoleLog = document.getElementById('consoleLog');
        const arenaEmptyState = document.getElementById('arenaEmptyState');
        const fighterSelection = document.getElementById('fighterSelection');
        const loginModal = document.getElementById('loginModal');
        const userApiKeyInput = document.getElementById('userApiKeyInput');
        
        // Battle Elements
        const fighter1Img = document.getElementById('fighter1Img');
        const fighter1Name = document.getElementById('fighter1Name');
        const fighter1Components = document.getElementById('fighter1Components');
        const fighter2Img = document.getElementById('fighter2Img');
        const fighter2Name = document.getElementById('fighter2Name');
        const fighter2Components = document.getElementById('fighter2Components');
        const fightBtn = document.getElementById('fightBtn');
        const fightStatus = document.getElementById('fightStatus');
        const battleResult = document.getElementById('battleResult');
        const battleResultImg = document.getElementById('battleResultImg');
        const battleDescription = document.getElementById('battleDescription');

        // --- LOGGING ---
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString([], { hour12: false });
            div.textContent = `> [${timestamp}] ${msg}`;
            if (type === 'error') div.classList.add('text-red-500');
            else if (type === 'success') div.classList.add('text-green-500');
            else if (type === 'warning') div.classList.add('text-yellow-500');
            else div.classList.add('text-gray-400');
            
            consoleLog.prepend(div);
        }

        // --- AUTH & SETTINGS ---
        function openLoginModal() {
            loginModal.classList.remove('hidden');
        }

        function closeLoginModal() {
            loginModal.classList.add('hidden');
        }

        function saveApiKey() {
            const inputKey = userApiKeyInput.value.trim();
            if (inputKey.length > 10) {
                apiKey = inputKey;
                log("API Key updated manually.", "success");
                closeLoginModal();
                loginAnonymously(); // Also auth with firebase if possible
            } else {
                alert("Please enter a valid API Key.");
            }
        }

        async function loginAnonymously() {
            if (!auth) return;
            try {
                const { signInAnonymously } = window.firebaseModules;
                await signInAnonymously(auth);
                closeLoginModal();
            } catch (error) {
                console.error(error);
                log("Guest login failed.", "error");
            }
        }

        // --- IMAGE GENERATION (API) ---
        async function generateImage(prompt) {
            // 1. Try Google Imagen First if Key Exists
            if (apiKey) {
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
                    
                    const payload = {
                        instances: [
                            { prompt: prompt }
                        ],
                        parameters: {
                            sampleCount: 1
                        }
                    };

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.predictions && data.predictions.length > 0) {
                            return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                        }
                    } else {
                         // Use text() to read error since standard json parsing might fail on some 400s
                        const errText = await response.text();
                        console.warn("Imagen API failed, switching to fallback:", errText);
                    }
                } catch (error) {
                    console.warn("Imagen API error, switching to fallback:", error);
                }
            } else {
                 log("No API Key detected. Using fallback model.", "warning");
            }

            // 2. Fallback: Pollinations.ai (Free, no key)
            // We fetch the blob to convert to base64 so it feels the same to the rest of the app
            try {
                log("Engaging auxiliary image protocol...", "warning");
                // Add seed to prompt to ensure uniqueness if prompt is same
                const seed = Math.floor(Math.random() * 10000);
                const fallbackUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt + " " + seed)}?nologo=true`;
                
                const resp = await fetch(fallbackUrl);
                if (!resp.ok) throw new Error('Fallback generation failed');
                
                const blob = await resp.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            } catch (e) {
                console.error(e);
                log("All generation protocols failed.", "error");
                return null;
            }
        }

        // --- HYBRID CREATION ---
        async function createHybrid() {
            const a1 = animal1Input.value.trim();
            const a2 = animal2Input.value.trim();

            if (!a1 || !a2) {
                log("Input required: Please enter two animals.", "error");
                return;
            }

            createBtn.disabled = true;
            createBtn.classList.add('opacity-50', 'cursor-not-allowed');
            creationStatus.classList.remove('hidden');
            log(`Initiating fusion: ${a1} + ${a2}...`);

            const prompt = `A realistic, high-quality photograph of a hybrid animal that is a combination of a ${a1} and a ${a2}. The creature should seamlessly blend features of both animals (e.g., texture, limbs, head). Cinematic lighting, 8k resolution, detailed texture.`;

            const imageUrl = await generateImage(prompt);

            if (imageUrl) {
                const hybridName = `${a1.substring(0, Math.ceil(a1.length/2))}${a2.substring(a2.length/2)}`; 
                
                const newCreature = {
                    id: Date.now(),
                    name: hybridName,
                    components: `${a1} + ${a2}`,
                    image: imageUrl
                };

                roster.unshift(newCreature);
                updateRosterUI();
                log(`Fusion complete. Specimen '${hybridName}' created.`, "success");
                
                animal1Input.value = '';
                animal2Input.value = '';
            }

            createBtn.disabled = false;
            createBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            creationStatus.classList.add('hidden');
        }

        // --- ROSTER UI ---
        function updateRosterUI() {
            rosterList.innerHTML = '';
            rosterCount.textContent = `${roster.length} SUBJECTS`;

            if (roster.length === 0) {
                rosterList.innerHTML = '<div class="text-center text-gray-600 py-8 text-sm italic">No subjects created yet.<br>Use the splicer above.</div>';
                return;
            }

            roster.forEach(creature => {
                const item = document.createElement('div');
                item.className = 'bg-black border border-gray-800 p-2 rounded flex gap-3 hover:border-cyan-500 transition cursor-pointer group';
                item.onclick = () => selectFighter(creature);

                item.innerHTML = `
                    <img src="${creature.image}" class="w-16 h-16 object-cover rounded border border-gray-700" alt="${creature.name}">
                    <div class="flex-grow flex flex-col justify-center">
                        <div class="font-bold text-cyan-400 group-hover:text-white transition">${creature.name}</div>
                        <div class="text-xs text-gray-500">${creature.components}</div>
                    </div>
                    <div class="flex flex-col justify-center">
                         <div class="text-xs bg-gray-900 text-gray-400 px-2 py-1 rounded group-hover:bg-cyan-900 group-hover:text-cyan-200">SELECT</div>
                    </div>
                `;
                rosterList.appendChild(item);
            });
        }

        // --- BATTLE LOGIC ---
        function selectFighter(creature) {
            if (!fighter1) {
                fighter1 = creature;
                log(`${creature.name} selected as Fighter 1.`);
            } else if (!fighter2 && fighter1.id !== creature.id) {
                fighter2 = creature;
                log(`${creature.name} selected as Fighter 2.`);
            } else if (fighter1 && fighter2) {
                fighter1 = creature;
                fighter2 = null;
                log(`Roster reset. ${creature.name} selected as Fighter 1.`);
            } else if (fighter1.id === creature.id) {
                log(`${creature.name} is already selected.`, "warning");
                return;
            }
            updateArenaUI();
        }

        function updateArenaUI() {
            if (fighter1 || fighter2) {
                arenaEmptyState.classList.add('hidden');
                fighterSelection.classList.remove('hidden');
                fighterSelection.classList.add('grid');
            } else {
                arenaEmptyState.classList.remove('hidden');
                fighterSelection.classList.add('hidden');
                fighterSelection.classList.remove('grid');
            }

            if (fighter1) {
                fighter1Img.src = fighter1.image;
                fighter1Name.textContent = fighter1.name;
                fighter1Name.classList.remove('text-gray-500');
                fighter1Components.textContent = fighter1.components;
            } else {
                fighter1Img.src = "https://via.placeholder.com/150/111/333?text=?";
                fighter1Name.textContent = "Select Fighter";
                fighter1Name.classList.add('text-gray-500');
            }

            if (fighter2) {
                fighter2Img.src = fighter2.image;
                fighter2Name.textContent = fighter2.name;
                fighter2Name.classList.remove('text-gray-500');
                fighter2Components.textContent = fighter2.components;
            } else {
                fighter2Img.src = "https://via.placeholder.com/150/111/333?text=?";
                fighter2Name.textContent = "Select Fighter";
                fighter2Name.classList.add('text-gray-500');
            }

            if (fighter1 && fighter2) {
                fightBtn.disabled = false;
                fightBtn.classList.add('animate-pulse-glow');
            } else {
                fightBtn.disabled = true;
                fightBtn.classList.remove('animate-pulse-glow');
            }
        }

        function resetArena() {
            fighter1 = null;
            fighter2 = null;
            updateArenaUI();
            log("Arena reset.");
        }

        async function startFight() {
            if (!fighter1 || !fighter2) return;

            fightBtn.disabled = true;
            fightStatus.classList.remove('hidden');
            log("INITIATING COMBAT SIMULATION...", "warning");

            const prompt = `An epic, cinematic action shot of a fight between two fantasy creatures. 
            On the left: a '${fighter1.name}' (hybrid of ${fighter1.components}). 
            On the right: a '${fighter2.name}' (hybrid of ${fighter2.components}). 
            They are clashing in a dramatic arena environment. Sparks, dynamic motion blur, intense lighting, hyper-realistic, 4k render, movie poster style.`;

            const imageUrl = await generateImage(prompt);

            if (imageUrl) {
                battleResultImg.src = imageUrl;
                battleDescription.textContent = `A legendary clash between the ${fighter1.name} and the ${fighter2.name}.`;
                battleResult.classList.remove('hidden');
                log("Combat simulation complete.", "success");
            } else {
                log("Combat simulation failed.", "error");
            }

            fightBtn.disabled = false;
            fightStatus.classList.add('hidden');
        }

        function closeBattleResult() {
            battleResult.classList.add('hidden');
        }

        // --- INIT ---
        window.onload = function() {
            log("Booting Core Systems...");
            setTimeout(initFirebase, 500); // Slight delay to ensure modules loaded
        };

    </script>
</body>
</html>